# 地图页面速度计算更新

## 更新概述

将地图页面的速度显示从虚拟数据改为基于实时 GPS 位置变化的真实计算。

## 主要修改

### 1. 新增速度计算相关变量

```dart
// 速度计算相关
DateTime? _lastPositionTime;
final List<double> _speedHistory = []; // 存储最近的速度数据用于平滑
static const int _maxSpeedHistorySize = 5; // 保留最近5个速度值
```

### 2. 实时速度计算函数

新增 `_calculateRealTimeSpeed()` 函数，基于以下原理计算速度：

- **距离计算**: 使用 `Geolocator.distanceBetween()` 计算两个 GPS 点之间的实际距离
- **时间差计算**: 基于 GPS 时间戳计算精确的时间间隔
- **速度计算**: 速度 = 距离 / 时间差
- **异常值过滤**: 过滤超过 50km/h 的异常速度值
- **平滑处理**: 使用移动平均算法平滑速度波动

### 3. 更新位置处理逻辑

修改 `_updateRunningPosition()` 函数：

- 使用计算出的实时速度替代 GPS 提供的速度值
- 确保速度计算的准确性和稳定性

### 4. 模拟模式优化

即使在模拟 GPS 模式下，也使用基于位置变化的真实速度计算，而不是虚拟生成的速度值。

### 5. UI 增强

- 在速度显示旁添加 📊 图标，表示使用实时计算
- 在跑步总结中标注"实时计算"字样
- 添加调试日志便于开发时监控速度计算过程

## 技术特点

### 准确性

- 基于真实的 GPS 位置变化计算速度
- 使用精确的地理距离计算公式
- 考虑 GPS 时间戳的精度

### 稳定性

- 异常值过滤机制
- 移动平均平滑算法
- 防止除零错误的保护机制

### 性能

- 轻量级计算，不影响地图渲染性能
- 合理的历史数据存储大小
- 高效的数据结构使用

## 使用效果

### 真实 GPS 模式

- 显示基于实际移动距离和时间的真实速度
- 速度变化更加自然和准确
- 适合真实跑步场景

### 模拟 GPS 模式

- 即使是模拟位置，速度也基于位置变化计算
- 提供更真实的测试体验
- 便于开发和调试

## 调试信息

在开发模式下，控制台会显示详细的速度计算信息：

```
📊 实时速度计算: 距离=15.2m, 时间=2.1s, 瞬时速度=26.1km/h
✅ 平滑后速度: 24.8km/h (基于3个数据点)
```

## 注意事项

1. GPS 精度会影响速度计算的准确性
2. 在室内或 GPS 信号差的环境下，速度可能不够准确
3. 建议在开阔地带使用以获得最佳效果
4. 异常值过滤阈值设置为 50km/h，适合跑步场景
